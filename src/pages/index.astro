---
import Layout from '../layouts/Layout.astro';

// --- SERVER SIDE LOGIC ---
const CHANNEL_ID = import.meta.env.CHANNEL_ID;
const API_KEY = import.meta.env.YOUTUBE_API_KEY;

let videos = [];
let error = null;

try {
  // 1. Get the "Uploads" Playlist ID for your channel
  const channelResponse = await fetch(
    `https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${CHANNEL_ID}&key=${API_KEY}`
  );
  const channelData = await channelResponse.json();
  const uploadsPlaylistId = channelData.items[0].contentDetails.relatedPlaylists.uploads;

  // 2. Fetch the latest 4 videos from that playlist
  const videoResponse = await fetch(
    `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${uploadsPlaylistId}&maxResults=4&key=${API_KEY}`
  );
  const videoData = await videoResponse.json();
  
  // 3. Clean up the data for our template
  videos = videoData.items.map(item => ({
    title: item.snippet.title,
    thumbnail: item.snippet.thumbnails.high.url,
    videoId: item.snippet.resourceId.videoId,
    url: `https://www.youtube.com/shorts/${item.snippet.resourceId.videoId}` // Force shorts URL
  }));

} catch (e) {
  console.error("YouTube Fetch Error:", e);
  // Fallback data if API fails (so build doesn't crash)
  error = "Could not fetch videos. Please check API Key.";
}

// --- STATIC DATA ---
const channelName = "SK History Journal";
const bio = "Documenting the past, one story at a time.";
const links = [
  { text: "ðŸ“º Watch on YouTube", url: `https://youtube.com/channel/${CHANNEL_ID}`, primary: true },
  { text: "ðŸ“œ Read the Blog", url: "#", primary: false },
];
---

<Layout title="Home">
  <main class="flex flex-col items-center pt-12 pb-12 text-center space-y-8">
    
    <div class="space-y-4">
        <div class="w-32 h-32 mx-auto rounded-full bg-amber-700 border-4 border-amber-500 shadow-xl flex items-center justify-center overflow-hidden">
             <img src="/logo-230w.png" alt="SK Logo" class="w-full h-full object-cover" /> 
        </div>
        
        <div>
            <h1 class="text-3xl font-bold text-white tracking-wide">{channelName}</h1>
            <p class="text-slate-400 mt-2 text-sm max-w-xs mx-auto">{bio}</p>
        </div>
    </div>

    <div class="w-full flex flex-col space-y-4">
      {links.map((link) => (
        <a 
          href={link.url}
          target="_blank"
          class={`
            block w-full py-4 rounded-xl font-semibold transition-transform hover:scale-105 active:scale-95
            ${link.primary 
              ? 'bg-amber-600 text-white shadow-lg shadow-amber-900/50' 
              : 'bg-slate-800 text-slate-200 border border-slate-700 hover:bg-slate-700'}
          `}
        >
          {link.text}
        </a>
      ))}
    </div>

    <div class="w-full pt-8 border-t border-slate-800">
        <h2 class="text-xl font-bold text-amber-500 mb-6 text-left">Latest Shorts</h2>
        
        {error && <p class="text-red-400 text-sm">{error}</p>}

        <div class="grid grid-cols-2 gap-4">
            {videos.map((video) => (
                <a href={video.url} target="_blank" class="group block relative overflow-hidden rounded-lg aspect-[9/16] bg-slate-800">
                    <img src={video.thumbnail} alt={video.title} class="w-full h-full object-cover group-hover:opacity-80 transition-opacity" />
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent p-3 pt-8">
                        <p class="text-xs text-white font-medium line-clamp-2 text-left">{video.title}</p>
                    </div>
                </a>
            ))}
        </div>
    </div>

  </main>
</Layout>